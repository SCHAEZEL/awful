$username = 'awfidius';
$password = read-host "Enter codeplex password:"

# Create MatlabAllHelp.html
# there's a race here, and -wait should fix it but doesn't.  
# Waiting for mathworks to fix.  It means that the posted
# documentation is out of date by one run, so build up a 
# latex-like mindset that you should always do one more for luck.
matlab -wait -norc -nosplash -nodisplay -noFigureWindows -nodesktop -r 'au_makedoc;exit'

# Generate the MATLAB help file for au_mex from au_mex_reference.txt
cat au_mex_reference.txt | % -PROCESS {
  $_ = $_ -replace '<pre>',''
  $_ = $_ -replace '</pre>',''
  "% $_"
} -END { 
  ""
  "% Autogenerated by ../doc/make-matlabhelp.ps1 from ../doc/au_mex_reference.txt"
} | out-file -enc ascii ../matlab/au_mex.m

# Generate au_mex_reference.html
@"
<h1>au_mex classes reference</h1>
Autogenerated from doc/au_mex_reference.txt
<br/>
"@ | out-file -enc ascii au_mex_reference.html
cat au_mex_reference.txt | % {
  "$_<br/>"
} | out-file -append -enc ascii au_mex_reference.html

# Generate doc page
$src = 'Documentation_template.html';
$dst = 'Documentation.html';
write-host "Making $dst"
echo "<<$src>>" | out-file -enc utf8 $dst
$contents_html = (cat Contents.html | % { $_ -replace '<!--.*-->', '' })
cat $src | % { 
  $_ -replace '<!TOC>',$contents_html
} | out-file -append -enc utf8 $dst

# Home page and doc page are the same.
write-host "Making Home.html"
copy $dst Home.html

# Publish...
write-host "Finding blog posts"
$p = ../powershell/metaweblog-get-posts.ps1 https://www.codeplex.com/site/metaweblog awful $username $password 10000
if (!$p) {
   throw "bad password?"
}

$pages = @(
'Home', 
'Documentation', 
'MatlabAllHelp',
'au_mex_reference'
#'au_mex.h'
)

foreach($page in $pages) {
  # mex_ref
  $post = $p | ? { $_.title -eq $page }
  write-host "Found post $($post.postId) for page [$page]"

  $post.description = cat "$page.html"

  write-host "Posting update from local $page.html"
  $out = ..\powershell\metaweblog-methodcall.ps1 https://www.codeplex.com/site/metaweblog editPost ($post.postId) $username $password $post.ToString() "<boolean>1</boolean>"
}
